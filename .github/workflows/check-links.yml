name: Broken Links
on:
  pull_request:
    types: [synchronize, ready_for_review, opened]
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      #- name: Waiting for Netlify Preview
      #  uses: josephduffy/wait-for-netlify-action@v1
      #  id: wait-for-netflify-preview
      #  with:
      #    site_name: "kongdocs"
      #    max_timeout: 600
      - name: List changed files
        run: |
          API_URL=$(jq --raw-output .pull_request._links.self.href "$GITHUB_EVENT_PATH")

          FILES=$(curl --request GET \
            --url "$API_URL/files?per_page=100" \
            --header "accept: application/vnd.github.v3+json" \
            --header "authorization: token ${{secrets.GITHUB_TOKEN}}")

          echo $FILES | jq '.[] | select(.status == "added" or .status == "modified") | .filename' > modified_files.json
          cat modified_files.json
      - name: Output changed files (Testing)
        run: |
          for changed_file in $(cat "modified_files.json"); do
            echo "Do something with this ${changed_file}."
          done
      - name: Filter down to just prose changes
        run: sleep 1
      - name: Check for broken Links
        run: |
          docker run raviqqe/muffet --one-page-only https://docs.konghq.com/gateway/ -c 32 --rate-limit=10 --exclude "https://(linkedin.com|cdn.segment.com)" -t 60
