---
title: Authentication Certificates for a Data Plane Node
content_type: how-to
---

{{site.konnect_short_name}} uses a mutual TLS handshake (mTLS) for authentication between data plane and control plane so the actual private key is never transferred on the network, and communication between the control plane and data plane nodes is secure. {{site.konnect_short_name}} supports two modes for handling certificate/key pairs:
* **Pinned mode**: This is the default mode. The same public key is added to the data plane and the control plane, and the control plane uses this public key to authenticate the data plane. Validation of the certificate only happens on the control plane.
* **Public Key Infrastructure (PKI) mode**: This mode uses digital certificates signed by a certificate authority, or a chain of certificate authorities, to authenticate between control plane and data plane. The public key is added to the data plane, while the chain of certificate authority is added to the control plane. Any certificate authority from the chain can be used to authenticate between dataplane and control plane.  {{site.konnect_short_name}} validates both the control plane and data plane sides by checking if they are from the same certificate authority, thereby increasing the security of the network and eliminating the risks associated with transporting private keys. This mode is only supported for Control Plane and Control Plane Groups.

## Set certificate authentication mode
You specify which certificate authentication mode is used at the control plane level. You can select between Pinned mode and PKI mode while creating a control plane, or edit the control plane to select a different mode. 

You need to upload enough of the certificate chain in the control plane so that the control plane can trust the certificate in the dataplane request and authenticate. 

Consider the following scenarios with this example cert chain:
   * `cert1`: service (issuer: intermediary)
   * `cert2`: intermediary (issuer: root)
   * `cert3`: root (issuer: root / self signed)

* **Upload only cert1 to the control plane**: This is the Pinned mode. You can include just `cert1` in your data plane request and not include the chain. The control plane doesnâ€™t need to evaluate the issuer because it trusts the cert itself.
* **Upload only cert2 to the control plane**: This would mean any cert coming in that has (issuer: intermediary) would be trusted. You can include just `cert1` in your data plane request. The control plane would trust any certificate issued by the intermediary public key. 
* **Upload only cert3 to the control plane**: This is the typical PKI case. It means any cert signed by the root is trusted. However, since `cert1` is signed by an intermediary and `cert2` is signed by root, you need to include both `cert1` and `cert2` in your data plane request. The control plane would trust the whole chain because `cert2` is issued by `cert3` and `cert1` is issued by `cert2`.

You can generate pinned certificates in {{site.konnect_short_name}} or bring your own pinned and PKI certificates. Data plane certificates generated by {{site.konnect_short_name}} expire every ten years. If you bring your own certificates, make sure to review the expiration date and associated metadata.

## Renew certificates

Renew your certificates to prevent any interruption in communication between
{{site.konnect_saas}} and any configured data plane nodes. The following happens if a certificate expires and isn't replaced: 
* The data plane node stops receiving configuration updates from
the control plane.
* The data plane node stops sending [analytics](/konnect/analytics/) and usage data
to the control plane.
* Each disconnected data plane node uses cached configuration to continue
proxying and routing traffic.

Depending on your setup, renewing certificates might mean bringing up a new data
plane, or generating new certificates and updating data plane nodes with the new
files.


### Quick setup

If you originally created your data plane node container using one of the
Docker options in Gateway Manager, we recommend creating a new data plane node with renewed
certificates.

1. Stop the data plane node container.
2. Open {% konnect_icon runtimes %} **Gateway Manager**, select a control plane, open **Data Plane Nodes** from the side menu, and click **New Data Plane Node**.
3. Run the script to create a new data plane node with
updated certificates.
4. Remove the old data plane node container.

### Advanced setup

If your data plane nodes are running on Linux or Kubernetes, or if you have a
Docker container that was _not_ created using the quick setup script, you must
generate new certificates and replace them on the existing nodes.


#### Generate new data plane certificate

{% navtabs %}
{% navtab Gateway Manager %}
You can generate a new data plane certificate from the {% konnect_icon runtimes %} **Gateway Manager**.

1. Select a control plane.
1. Click **Actions** and select **Data plane certificates**. 
1. Click **Generate certificate**.

1. Save the new certificate and key into separate files:

    * certificate: `tls.crt`
    * private key: `tls.key`

1. Store the files on the local file system.
{% endnavtab %}

{% navtab Konnect API %}

You can generate a certificate locally and use the [pin data plane client certificate](/konnect/api/control-plane-configuration/latest/#/DP%20Certificates/post-dp-client-certificates) endpoint to add it to {{site.konnect_short_name}}.

1.  Generate a new certificate and key:

    ```bash
    openssl req -new -x509 -nodes -newkey rsa:2048 -subj "/CN=kongdp/C=US" -keyout ./tls.key -out ./tls.crt
    ```

1. Reformat the certificate into a single line for the API call:

    ```bash
    export CERT=$(awk 'NF {sub(/\r/, ""); printf "%s\\n",$0;}' tls.crt)
    ```

1. `POST` the certificate to your control plane using the Konnect API:

    ```bash
    curl https://{region}.api.konghq.com/v2/control-planes/{controlPlaneId}/dp-client-certificates --json '{"cert":"'$CERT'"}'
    ```
{% endnavtab %}
{% endnavtabs %}

#### Update data plane

{% navtabs %}
{% navtab Linux %}

Open your node's `kong.conf` file. Replace existing certificates with
the new files:

```sh
cluster_cert = /{PATH_TO_FILE}/tls.crt
cluster_cert_key = /{PATH_TO_FILE}/tls.key
```

Restart {{site.base_gateway}} for the settings to take effect:

```sh
kong restart
```

Delete any old certificate and key files on your filesystem.

{% endnavtab %}
{% navtab Kubernetes %}

Create new secrets for the certificates and key, making sure to name them
something different from the current secret names.

1. Create a `tls` secret using the `tls.cert` and `tls.key` files
you saved earlier:

    ```sh
    kubectl create secret tls kong-cluster-cert2 -n kong \
      --cert=/PATH_TO_FILE/tls.crt \
      --key=/PATH_TO_FILE/tls.key
    ```

1. Open the `values.yaml` file for the data plane node and update it to point
to the new secrets.

    Update the `secretVolumes` section:

    ```yaml
    secretVolumes:
    - kong-cluster-cert2
    ```

    Update the cert values in the `env` section:
    ```yaml
    env:
      cluster_cert: /etc/secrets/kong-cluster-cert2/tls.crt
      cluster_cert_key: /etc/secrets/kong-cluster-cert2/tls.key
    ```

1. Save the file. Reapply the configuration by running the Helm `upgrade`
command:

    ```bash
    helm upgrade my-kong kong/kong -n kong \
      --values ./values.yaml
    ```

1. Delete the old `kong-cluster-cert` secret:

    ```sh
    kubectl delete secret kong-cluster-cert
    ```

{% endnavtab %}
{% navtab Docker %}

In your Docker container, replace any existing certificates on your data plane nodes
with the new files and restart the Gateway:

```sh
echo "KONG_CLUSTER_CERT=/{PATH_TO_FILE}/tls.crt \
  KONG_CLUSTER_CERT_KEY=/{PATH_TO_FILE}/tls.key \
  kong reload exit" | docker exec -i {KONG_CONTAINER_ID} /bin/sh
```

Delete any old certificate and key files on your filesystem.

{% endnavtab %}
{% endnavtabs %}

