---
nav_title: Customize Kafka Message Format with Kafka Upstream Plugin
title: Customize Kafka Message Format with Kafka Upstream Plugin
minimum_version: 3.10.x
---

## Customize Kafka Message Format with Kafka Upstream Plugin

Since {{site.base_gateway}} 3.10, the Kafka Upstream Plugin supports creating customized Kafka message format within the Kafka Upstream Plugin.
By using the new configuration field `message_by_lua_functions`, user can define a function chain with multiple functions that can manipulate not only the Kafka message format but also the content of the message.

## How-To

The new configuration field `message_by_lua_functions` is added in {{site.base_gateway}} 3.10. This field is an array of strings that each of the strings is a customized Lua function. The default message generated by the Kafka Upstream plugin will get reduced through these functions:

```
Message(default) -> f1(Message) -> f2(Message) -> ... -> Producer(New_Message)
```

The format of a single Lua function configured in the field `message_by_lua_functions`, must be in the following format:

```
return function(message)
    ... -- Some manipulation code
    return new_message
end
```

It should be a function that receives one message argument, and return a new message as the single return value.

## Example


### A function that does nothing

You can just return the message argument as the return value, so that the function has no modification on the default message.

```
return function(message)
    return message
end
```

Configure this function with an example declarative config:

```
_format_version: "3.0"
services:
  - name: kafka-service
    url: http://mock-upstream
    routes:
      - name: kafka-route
        paths:
          - /kafka
    plugins:
      - name: kafka-upstream
        config:
          bootstrap_servers:
            - host: localhost
              port: 9092
          topic: "my-topic"
          forward_method: true
          forward_uri: true
          forward_headers: true
          forward_body: true
          message_by_lua_functions:
            - 'return function(message) return message end'
```

Sending request to the route path, and check the message(make sure the topic is created):

```
> curl http://localhost:8000/kafka
{"message":"message sent"}

# Using the kcat tool to quickly check the message, the default message was sent to the topic, as showed below
> kcat -b 127.0.0.1:9092 -G mygroup1 -o beginning -t my-topic -p 0 -C
{"body_base64":true,"headers":{"accept":"*\/*","host":"localhost:8000","user-agent":"curl\/8.7.1"},"uri_args":{},"uri":"\/kafka","body_args":{},"body":"","method":"GET"}
```


### A function that returns a fixed table

In the custom function, users can return whatever data they want as the return value. Please note that the returned value must be JSON serialize-able, otherwise it cannot be sent to Kafka.

```
return function(message)
    return {a="1", b="2"}
end
```

Configure this function with an example declarative config:

```
_format_version: "3.0"
services:
  - name: kafka-service
    url: http://mock-upstream
    routes:
      - name: kafka-route
        paths:
          - /kafka
    plugins:
      - name: kafka-upstream
        config:
          bootstrap_servers:
            - host: localhost
              port: 9092
          topic: "my-topic"
          message_by_lua_functions:
            - 'return function(message) return {a="1", b="2"} end'
```

Sending request to the route path, and check the message(make sure the topic is created):

```
> curl http://localhost:8000/kafka
{"message":"message sent"}

# Using the kcat tool to quickly check the message, the new message was sent to the topic
> kcat -b 127.0.0.1:9092 -G mygroup1 -o beginning -t my-topic -p 0 -C
.....OLD MESSAGES.....
% Reached end of topic my-topic [0] at offset 8
{"b":"2","a":"1"}
% Reached end of topic my-topic [0] at offset 9
```

Users can also return the already encoded message string as a return value:

```
return function(message)
    return [[{"a":"1","b":"2"}]]
end
```

The result should be the same as the one returned the `{a="1", b="2"}` table as return value.

{:.warning}
> **Note**: Currently the Kafka Upstream plugin only supports JSON encoding on the message. Other serliazation methods are not supported.


### Functions that insert the consumer info and make a sensitive api request header redacted

Create two functions that call the `get_consumer` PDK function and manipulate the request header information.

```
--- FUNCTION 1 that inject the consumer information to the message
return function(message)
    message.consumer = kong.client.get_consumer()

    return message
end
```

```
--- FUNCTION 2 that clean an apikey header
return function(message)
    local headers = message and message.headers
    local apikey = headers and headers.apikey
    if apikey then
        headers.apikey = "[REDACTED]"
    end

    return message
end
```

Create an example declarative config for these two functions:

```
_format_version: "3.0"

services:
  - name: kafka-service
    url: http://mock-upstream
    routes:
      - name: kafka-route
        paths:
          - /kafka
    plugins:
      - name: key-auth
      - name: kafka-upstream
        config:
          bootstrap_servers:
            - host: localhost
              port: 9092
          topic: "my-topic"
          forward_method: true
          forward_uri: true
          forward_headers: true
          forward_body: true
          message_by_lua_functions:
            - "return function(message) message.consumer = kong.client.get_consumer() return message end"
            - "return function(message) local headers = message and message.headers local apikey = headers and headers.apikey if apikey then headers.apikey = '[REDACTED]' end return message end"

consumers:
  - username: alice
    keyauth_credentials:
      - key: "example-api-key"
```

Trigger the API call and check the message:

```
> curl http://localhost:8000/kafka -H 'apikey: example-api-key'
{"message":"message sent"}

> kcat -b 127.0.0.1:9092 -G mygroup1 -o beginning -t my-topic -p 0 -C
.....OLD MESSAGES.....
% Reached end of topic my-topic [0] at offset 20
{"body_base64":true,"method":"GET","consumer":{"id":"25f66f8c-b5e1-4bbd-9b17-2cbe733d1895","created_at":1741768764,"username":"alice","username_lower":"alice","type":0,"updated_at":1741768764},"body_args":{},"body":"","headers":{"apikey":"[REDACTED]","accept":"*\/*","host"
:"localhost:8000","x-consumer-id":"25f66f8c-b5e1-4bbd-9b17-2cbe733d1895","x-credential-identifier":"795fb073-f698-403d-9302-209ba3abdd55","user-agent":"curl\/8.7.1","x-consumer-username":"alice"},"uri_args":{},"uri":"\/kafka"}
% Reached end of topic my-topic [0] at offset 21
```
